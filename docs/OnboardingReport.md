# Onboarding Report

**Date:** January 3, 2026
**Generated by:** Gemini CLI

## 1. Architecture Summary

The `Gfx-Engine` is a 2D pixel-art game engine built on a high-fidelity **WYSIWID (What You See Is What It Does)** architecture using Rust and SDL3. The core design philosophy centers on an **Event-Driven Entity-Component-System (ECS)** that strictly separates domain logic from behavioral rules.

### Core Pillars
*   **Event-Driven ECS:** The engine separates data (`Components`), logic (`Systems`), and communication (`Events`).
*   **Concepts vs. Synchronizations:**
    *   **Concepts:** Independent, domain-specific systems (e.g., `SystemPhysics`, `SystemAudio`) that own their data and never call other systems directly.
    *   **Synchronizations:** "Glue" systems (e.g., `SystemSynchronization`) that listen for events and orchestrate reactions, defining the game's rules without coupling the concepts.
*   **Explicit Scheduler:** The `SystemManager` explicitly defines the execution order of systems based on the current `GameState`, eliminating hidden control flows.
*   **Deterministic Loop:** A fixed timestep (120Hz) accumulator loop ensures deterministic physics and enables features like the Input Replay System.

### Key Components
*   **`App` (`src/app.rs`):** Manages the main loop, window, and high-level resources. It delegates logic to the `GameStateManager` and rendering to the `Renderer`.
*   **`SystemManager` (`src/ecs/system_manager.rs`):** The central hub that orchestrates the update of all ECS systems.
*   **`Renderer` (`src/renderer.rs`):** Handles all drawing operations, supporting Z-layering and state interpolation.

## 2. Baseline Verification

*   **Tests:** `cargo test` passed successfully (4 tests).
*   **Linter:** `cargo clippy` reported **1 warning** (`clone_on_copy` in `src/game_state_manager.rs`).
*   **Build:** The project compiles and runs.

## 3. Suggestions & Roadmap

Based on the analysis of the codebase and `docs/Tasks.md`, the following actions are recommended, prioritized by architectural impact and risk reduction.

### High Priority (Architectural Integrity)

1.  **Refactor `SystemLifecycle` (Atomic Modularity):**
    *   **Issue:** `SystemLifecycle` violates the Single Responsibility Principle by managing health, timers, death logic, and respawn sequencing.
    *   **Action:** Decompose it into:
        *   `ConceptHealth`: Pure arithmetic for health and mortality.
        *   `ConceptVitality`: Management of `Invincibility` and `Lifetime` timers.
        *   `RuleRespawn`: A synchronization rule to orchestrate the respawn sequence (Event-driven).

2.  **Fix Clippy Warning:**
    *   **Issue:** `src/game_state_manager.rs:200` calls `.clone()` on `GameState`, which implements `Copy`.
    *   **Action:** Remove the redundant `.clone()` call.

3.  **Refactor `SystemManager` Audio Logic:**
    *   **Issue:** The `SystemManager::update` method contains complex logic for audio beat detection and event publishing. This pollutes the scheduler.
    *   **Action:** Extract this logic into a dedicated `ConceptAudioAnalysis` or `SystemAudio` update method.

### Medium Priority (WYSIWID & Legibility)

4.  **Complete `SystemSynchronization` Migration:**
    *   **Issue:** Some "Game Rules" are still scattered.
    *   **Action:**
        *   Move Goal Detection from `SystemWorldLevelTransition` to a pure `ConceptGoalDetector` + `RuleLevelTransition`.
        *   Ensure `SystemInteraction` acts solely as an Arbiter (publishing events), moving all consequence logic to `SystemSynchronization`.

5.  **Atomic Module Audit:**
    *   **Issue:** Several files exceed the 300-line "Atomic Module" limit, reducing maintainability.
    *   **Action:** Refactor the following candidates:
        *   `src/config/game.rs` (516 lines)
        *   `src/game_state_manager.rs` (443 lines)
        *   `src/app.rs` (411 lines)

### Low Priority (Feature & Polish)

6.  **Enhance Test Coverage:**
    *   **Issue:** While core tests exist, complex interactions in `SystemSynchronization` lack specific contract tests.
    *   **Action:** Add unit tests for `SystemSynchronization` verifying that specific `EventCollision` inputs result in the correct `EventCoinCollected` or `EventPlayerDamaged` outputs.

7.  **Documentation Update:**
    *   **Action:** Update `docs/Structure.md` to reflect the new decomposed system architecture once the refactoring is complete.
